plugins {
    id 'groovy'
    id 'application'
}

group = 'org.example'
version = '1.0-SNAPSHOT'

repositories {
    mavenCentral()
}

dependencies {
    implementation "org.apache.groovy:groovy:$groovyVersion"
    implementation "org.apache.groovy:groovy-json:$groovyVersion"
    implementation "org.apache.groovy:groovy-sql:$groovyVersion"
    implementation "com.hazelcast:hazelcast:5.6.0"
    implementation("org.slf4j:slf4j-api:2.0.17")
    implementation("ch.qos.logback:logback-classic:1.5.20")
    implementation "org.yaml:snakeyaml:2.5"
    //two serialisers - EclipseStore (successor to MicroStream, Java 25 compatible)
    implementation "org.eclipse.store:storage-embedded:3.1.0"
    implementation "org.eclipse.store:storage-embedded-configuration:3.1.0"
    implementation "org.eclipse.serializer:serializer:2.0.0"  // EclipseStore binary serializer
    implementation 'org.msgpack:msgpack-core:0.9.10'  //msgpack serializer

    implementation 'io.vertx:vertx-core:5.0.5'
    implementation 'io.projectreactor:reactor-core:3.8.0'
    // RSocket Core
    implementation 'io.rsocket:rsocket-core:1.1.5'
    implementation 'io.rsocket:rsocket-transport-netty:1.1.5'

    // Netty (if not already included)
    implementation 'io.netty:netty-all:4.2.7.Final'

    // Optional: RSocket Load Balancer
    implementation 'io.rsocket:rsocket-load-balancer:1.1.5'

    //javascript for script engine loading
    implementation("org.openjdk.nashorn:nashorn-core:15.7")

    testImplementation platform('org.junit:junit-bom:5.10.0')
    testImplementation 'org.junit.jupiter:junit-jupiter'
    testRuntimeOnly 'org.junit.platform:junit-platform-launcher'
    testImplementation 'org.apache.groovy:groovy-test:5.0.2'
    testImplementation 'io.vertx:vertx-junit5:5.0.5'
    testImplementation("io.projectreactor:reactor-test:3.8.0")
    testImplementation 'org.awaitility:awaitility:4.3.0'
    testImplementation 'org.spockframework:spock-core:2.4-groovy-5.0'
    testImplementation 'org.wiremock:wiremock:3.3.1'
    testImplementation 'com.h2database:h2:2.2.224'
}

//hack to use spock with version 5 groovy till put up on maven
/*
tasks.withType(GroovyCompile).configureEach {
    options.forkOptions.jvmArgs << '-Dspock.iKnowWhatImDoing.disableGroovyVersionCheck=true'    //it works! But be aware that "options" not "groovyOptions"!
}
*/

java {
    toolchain {
        languageVersion = JavaLanguageVersion.of(25)
    }
}

tasks.withType(JavaCompile).configureEach {
    options.release = 25
}


test {
    useJUnitPlatform()

    // Suppress Hazelcast Java module warnings
    jvmArgs = [
            '--add-modules', 'java.se',
            '--add-exports', 'java.base/jdk.internal.ref=ALL-UNNAMED',
            '--add-opens', 'java.base/java.lang=ALL-UNNAMED',
            '--add-opens', 'java.base/sun.nio.ch=ALL-UNNAMED',
            '--add-opens', 'java.management/sun.management=ALL-UNNAMED',
            '--add-opens', 'jdk.management/com.sun.management.internal=ALL-UNNAMED'
    ]
}

application {
    // Fully qualified main class containing 'static void main(String[] args)'
    mainClass = 'org.softwood.Main'
}