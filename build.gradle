
import org.asciidoctor.gradle.jvm.AsciidoctorTask
import org.gradle.api.publish.maven.tasks.PublishToMavenRepository
import org.gradle.plugins.signing.Sign

plugins {
    id 'groovy'
    id 'java-library'
    id 'idea'
    id "org.asciidoctor.jvm.convert" version "4.0.5"
    id 'maven-publish'
    id 'signing'
    id 'io.github.gradle-nexus.publish-plugin' version '2.0.0'

}

group = 'org.softwood'
version = '1.0-SNAPSHOT'

repositories {
    mavenCentral()
}

dependencies {
    implementation "org.apache.groovy:groovy:$groovyVersion"
    implementation "org.apache.groovy:groovy-json:$groovyVersion"
    implementation "org.apache.groovy:groovy-sql:$groovyVersion"
    implementation "org.apache.groovy:groovy-templates:$groovyVersion"
    implementation "com.hazelcast:hazelcast:5.6.0"
    implementation("org.slf4j:slf4j-api:2.0.17")
    implementation("ch.qos.logback:logback-classic:1.5.20")
    implementation "org.yaml:snakeyaml:2.5"

    //mail client
    implementation("org.simplejavamail:simple-java-mail:8.12.6")

    //two serialisers - EclipseStore (successor to MicroStream, Java 25 compatible)
    implementation "org.eclipse.store:storage-embedded:3.1.0"
    implementation "org.eclipse.store:storage-embedded-configuration:3.1.0"
    implementation "org.eclipse.serializer:serializer:2.0.0"  // EclipseStore binary serializer
    implementation 'org.msgpack:msgpack-core:0.9.10'  //msgpack serializer

    implementation 'io.vertx:vertx-core:5.0.5'
    implementation 'io.projectreactor:reactor-core:3.8.0'
    // RSocket Core
    implementation 'io.rsocket:rsocket-core:1.1.5'
    implementation 'io.rsocket:rsocket-transport-netty:1.1.5'

    // Netty (if not already included)
    implementation 'io.netty:netty-all:4.2.7.Final'

    // Optional: RSocket Load Balancer
    implementation 'io.rsocket:rsocket-load-balancer:1.1.5'

    //javascript for script engine loading
    implementation("org.openjdk.nashorn:nashorn-core:15.7")

    testImplementation platform('org.junit:junit-bom:5.10.0')
    testImplementation 'org.junit.jupiter:junit-jupiter'
    testRuntimeOnly 'org.junit.platform:junit-platform-launcher'
    testImplementation 'org.apache.groovy:groovy-test:5.0.2'
    testImplementation 'io.vertx:vertx-junit5:5.0.5'
    testImplementation("io.projectreactor:reactor-test:3.8.0")
    testImplementation 'org.awaitility:awaitility:4.3.0'
    testImplementation 'org.spockframework:spock-core:2.4-groovy-5.0'
    testImplementation 'org.wiremock:wiremock:3.3.1'
    testImplementation 'com.h2database:h2:2.2.224'
}


java {
    toolchain {
        languageVersion = JavaLanguageVersion.of(25)
    }
}

tasks.withType(JavaCompile).configureEach {
    options.release = 25
}

/**
 * Asciidoctor docs
 * Assumes docs live under src/docs/asciidoc (as in your project structure)
 */
tasks.named("asciidoctor", AsciidoctorTask).configure { t ->
    t.sourceDir = layout.projectDirectory.dir("src/main/groovy/org/softwood/dag/docs/asciidoc").asFile

    t.sources {
        include("**/*.adoc")
    }

    t.outputDir = layout.buildDirectory.dir("docs/asciidoc").get().asFile
    t.baseDirFollowsSourceDir()

    t.resources {
        from(t.sourceDir) {
            include("images/**")
            include("css/**")
        }
    }

    t.attributes(
            "stylesheet": "style.css",
            "stylesdir": "css"
    )
}

tasks.named("build").configure {
    dependsOn(tasks.named("asciidoctor"))
}

test {
    useJUnitPlatform()

    // Suppress Hazelcast Java module warnings
    jvmArgs = [
            '--add-modules', 'java.se',
            '--add-exports', 'java.base/jdk.internal.ref=ALL-UNNAMED',
            '--add-opens', 'java.base/java.lang=ALL-UNNAMED',
            '--add-opens', 'java.base/sun.nio.ch=ALL-UNNAMED',
            '--add-opens', 'java.management/sun.management=ALL-UNNAMED',
            '--add-opens', 'jdk.management/com.sun.management.internal=ALL-UNNAMED'
    ]
}


/**
 * Publishing
 */
publishing {
    publications {
        mavenJava(MavenPublication) {
            from components.java

            pom {
                name.set(providers.gradleProperty('pomName').orElse('GroovyFX'))
                description.set(providers.gradleProperty('pomDescription')
                        .orElse('GroovyFX next-generation builder for JavaFX 25 + Groovy 5'))
                url.set(providers.gradleProperty('pomUrl').orElse('https://github.com/woodmawa/groovyfx'))

                licenses {
                    license {
                        name.set('The Apache License, Version 2.0')
                        url.set('https://www.apache.org/licenses/LICENSE-2.0.txt')
                    }
                }

                developers {
                    developer {
                        id.set(providers.gradleProperty('pomDeveloperId').orElse('woodmawa'))
                        name.set(providers.gradleProperty('pomDeveloperName').orElse('woodmawa'))
                        email.set(providers.gradleProperty('pomDeveloperEmail').orElse(''))
                    }
                }

                scm {
                    connection.set(providers.gradleProperty('pomScmConnection')
                            .orElse('scm:git:https://github.com/woodmawa/groovyfx.git'))
                    developerConnection.set(providers.gradleProperty('pomScmDeveloperConnection')
                            .orElse('scm:git:ssh://git@github.com:woodmawa/groovyfx.git'))
                    url.set(providers.gradleProperty('pomScmUrl')
                            .orElse('https://github.com/woodmawa/groovyfx'))
                }
            }
        }
    }
}

/**
 * Credentials / Signing
 */
def sonatypeUsername = (findProperty('sonatypeUsername') ?: System.getenv('SONATYPE_USERNAME'))?.toString()
def sonatypePassword = (findProperty('sonatypePassword') ?: System.getenv('SONATYPE_PASSWORD'))?.toString()
def signingKey       = (findProperty('signingKey')       ?: System.getenv('SIGNING_KEY'))?.toString()
def signingPassword  = (findProperty('signingPassword')  ?: System.getenv('SIGNING_PASSWORD'))?.toString()

signing {
    if (signingKey && signingPassword) {
        useInMemoryPgpKeys(signingKey, signingPassword)
    }
    sign publishing.publications.mavenJava
}

/**
 * Fail-fast checks for Sonatype publish actions
 */
def isMavenLocalInvocation = gradle.startParameter.taskNames.any { it.toLowerCase().contains('mavenlocal') }
def isCentralInvocation = !isMavenLocalInvocation && gradle.startParameter.taskNames.any { t ->
    def n = t.toLowerCase()
    n.contains('sonatype') || n.contains('mavencentral') || n.contains('staging') ||
            n == 'publish' || n.endsWith(':publish')
}

def requireCentralSecrets = { String action ->
    def missing = []
    if (!sonatypeUsername || !sonatypePassword) missing << "Sonatype credentials (sonatypeUsername/sonatypePassword or env)"
    if (!signingKey || !signingPassword) missing << "Signing key (signingKey/signingPassword or env)"
    if (!missing.isEmpty()) {
        throw new GradleException("Cannot run '${action}' without: ${missing.join('; ')}")
    }
}

def validateCentralSecrets = tasks.register('validateCentralSecrets') {
    group = 'publishing'
    description = 'Validates Sonatype + signing secrets for Maven Central publishing.'
    onlyIf { isCentralInvocation }
    doLast { requireCentralSecrets(path) }
}

tasks.withType(Sign).configureEach { t ->
    onlyIf { isCentralInvocation }
    dependsOn(validateCentralSecrets)
}

tasks.withType(PublishToMavenRepository).configureEach { t ->
    if (t.repository?.name == 'sonatype') {
        t.doFirst { requireCentralSecrets(t.path) }
    }
}

/**
 * Nexus publish plugin
 */
nexusPublishing {
    repositories {
        sonatype {
            username = providers.gradleProperty('sonatypeUsername').orNull ?: sonatypeUsername
            password = providers.gradleProperty('sonatypePassword').orNull ?: sonatypePassword
        }
    }
}

/**
 * Convenience alias:
 *   ./gradlew publishToMavenCentral
 */
tasks.register('publishToMavenCentral') {
    group = 'publishing'
    description = 'Publishes to Sonatype/Maven Central (snapshots go to snapshots repo; releases are staged then closed+released).'

    dependsOn tasks.named('publish')

    if (!version.toString().endsWith('-SNAPSHOT')) {
        finalizedBy tasks.named('closeAndReleaseSonatypeStagingRepository')
    }
}

